<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PrincePost</title>
  <link rel="icon" href="favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://use.typekit.net/gkx8zdh.css">
  <link rel="stylesheet" href="https://use.typekit.net/kha5kwj.css">
  <link rel="stylesheet" href="https://s3.amazonaws.com/static.getsnworks.com/fontawesome/5.15.2/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #eaeaea;
      padding: 20px;
      color: #000000;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #eaeaea;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #000000;
    }

    .input-section {
      margin-bottom: 30px;
    }

    .input-section h2 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #000000;
    }

    #quoteInput {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 2px solid #eaeaea;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      background: #ffffff;
      color: #000000;
    }

    #quoteInput:focus {
      border-color: #b1d7fb;
      outline: none;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #f15a24;
      color: #ffffff;
    }

    .btn-primary:hover {
      background: #e87722;
    }

    .btn-secondary {
      background: #eaeaea;
      color: #000000;
    }

    .btn-secondary:hover {
      background: #b1d7fb;
      color: #000000;
    }

    .btn-success {
      background: #f15a24;
      color: #ffffff;
    }

    .btn-success:hover {
      background: #e87722;
    }

    .slides-section {
      margin-top: 30px;
    }

    .slide-card {
      background: #ffffff;
      border: 2px solid #eaeaea;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .slide-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .slide-title {
      font-size: 16px;
      font-weight: 600;
      color: #000000;
    }

    .slide-controls {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-danger {
      background: #000000;
      color: #ffffff;
    }

    .btn-danger:hover {
      background: #333;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 5px;
      color: #000000;
    }

    select, input[type="text"], input[type="url"] {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #eaeaea;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      background: #ffffff;
      color: #000000;
    }

    select:focus, input[type="text"]:focus, input[type="url"]:focus {
      border-color: #b1d7fb;
      outline: none;
    }

    .text-chunk {
      position: relative;
      margin-bottom: 10px;
    }

    .editable-text {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border: 1px solid #eaeaea;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      background: #ffffff;
      color: #000000;
    }

    .editable-text:focus {
      outline: 2px solid #b1d7fb;
      border-color: #b1d7fb;
    }

    .editable-text b {
      color: #f15a24;
      font-weight: 600;
    }

    .chunk-controls {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    .add-chunk-btn {
      margin-top: 10px;
    }

    .speaker-position-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .json-output {
      margin-top: 30px;
      padding: 20px;
      background: #eaeaea;
      border-radius: 6px;
      border: 2px solid #eaeaea;
    }

    .json-output h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #000000;
    }

    .json-display {
      background: #ffffff;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre;
      border: 1px solid #eaeaea;
      color: #000000;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #000000;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: #f15a24;
      color: #ffffff;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s;
      pointer-events: none;
    }

    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* --- Cover template thumbnail grid (updated) --- */
    .cover-thumb-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .cover-thumb {
      appearance: none;
      border: 2px solid #eaeaea;
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      text-align: left;
      cursor: pointer;
      transition: transform 0.08s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .cover-thumb:hover {
      transform: translateY(-1px);
      border-color: #b1d7fb;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .cover-thumb[aria-pressed="true"] {
      border-color: #f15a24;
      box-shadow: 0 0 0 3px rgba(241,90,36,0.25);
    }

    /* Keep the entire PNG visible (all are 540x675) */
    .cover-thumb .thumb-frame {
      width: 100%;
      aspect-ratio: 540 / 675;
      border-radius: 8px;
      border: 1px solid #eaeaea;
      background: #eaeaea;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cover-thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain; /* show full image */
      display: block;
      background: transparent;
    }

    .cover-thumb .cover-thumb-title {
      margin-top: 8px;
      font-size: 13px;
      font-weight: 600;
      color: #000000;
    }

    /* Footer */
    .app-footer {
      margin-top: 28px;
      padding-top: 16px;
      border-top: 1px solid #eaeaea;
      font-size: 12px;
      color: #000000;
      text-align: center;
    }
    /* --- Slide template picker + per-slide preview --- */

.slide-template-picker {
  margin-top: 12px;
  padding: 12px;
  border: 1px solid #eaeaea;
  border-radius: 8px;
  background: #eaeaea;
}

.slide-template-picker-row {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}

.slide-template-picker-row select {
  flex: 1;
}

.slide-thumb-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 12px;
}

.slide-thumb {
  appearance: none;
  border: 2px solid #e0e0e0;
  background: #fff;
  border-radius: 10px;
  padding: 10px;
  text-align: left;
  cursor: pointer;
  transition: transform 0.08s ease, border-color 0.15s ease, box-shadow 0.15s ease;
}

.slide-thumb:hover {
  transform: translateY(-1px);
  border-color: #cfcfcf;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.slide-thumb[aria-pressed="true"] {
  border-color: #f15a24;
  box-shadow: 0 0 0 3px rgba(241,90,36,0.25);
}

.slide-thumb .thumb-frame {
  width: 100%;
  aspect-ratio: 540 / 675; /* matches your 540x675 thumbnails */
  border-radius: 8px;
  border: 1px solid #eaeaea;
  background: #eaeaea;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.slide-thumb img {
  width: 100%;
  height: 100%;
  object-fit: contain; /* show entire thumbnail */
  display: block;
}

.slide-thumb .slide-thumb-title {
  margin-top: 8px;
  font-size: 13px;
  font-weight: 600;
  color: #000000;
}

/* Per-slide template row with preview on the right */
.template-row {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.template-row .template-select {
  flex: 1;
}

.slide-template-preview {
  width: 110px;
  aspect-ratio: 540 / 675;
  border-radius: 8px;
  border: 1px solid #eaeaea;
  background: #eaeaea;
  overflow: hidden;
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

.slide-template-preview img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}
/* --- Slide template picker + per-slide preview --- */

.slide-template-picker {
  margin-top: 12px;
  padding: 12px;
  border: 1px solid #eaeaea;
  border-radius: 8px;
  background: #eaeaea;
}

.slide-template-picker-row {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}

.slide-template-picker-row select {
  flex: 1;
}

.slide-thumb-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 12px;
}

.slide-thumb {
  appearance: none;
  border: 2px solid #e0e0e0;
  background: #fff;
  border-radius: 10px;
  padding: 10px;
  text-align: left;
  cursor: pointer;
  transition: transform 0.08s ease, border-color 0.15s ease, box-shadow 0.15s ease;
}

.slide-thumb:hover {
  transform: translateY(-1px);
  border-color: #cfcfcf;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.slide-thumb[aria-pressed="true"] {
  border-color: #f15a24;
  box-shadow: 0 0 0 3px rgba(241,90,36,0.25);
}

.slide-thumb .thumb-frame {
  width: 100%;
  aspect-ratio: 540 / 675; /* matches your 540x675 thumbnails */
  border-radius: 8px;
  border: 1px solid #eaeaea;
  background: #eaeaea;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.slide-thumb img {
  width: 100%;
  height: 100%;
  object-fit: contain; /* show entire thumbnail */
  display: block;
}

.slide-thumb .slide-thumb-title {
  margin-top: 8px;
  font-size: 13px;
  font-weight: 600;
  color: #000000;
}

/* Per-slide template row with preview on the right */
.template-row {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.template-row .template-select {
  flex: 1;
}

.slide-template-preview {
  width: 110px;
  aspect-ratio: 540 / 675;
  border-radius: 8px;
  border: 1px solid #eaeaea;
  background: #eaeaea;
  overflow: hidden;
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

.slide-template-preview img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

  

    /* --- Per-slide right-side thumbnail preview (same size as selection thumbs) --- */
    .slide-card-body {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .slide-card-main {
      flex: 1 1 auto;
      min-width: 0;
    }

    .slide-card-side {
      flex: 0 0 180px; /* roughly matches the selection thumbnail card width */
    }

    .slide-side-preview {
      border: 2px solid #e0e0e0;
      background: #fff;
      border-radius: 10px;
      padding: 10px;
    }

    .slide-side-preview .thumb-frame {
      width: 100%;
      aspect-ratio: 540 / 675;
      border-radius: 8px;
      border: 1px solid #eaeaea;
      background: #eaeaea;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slide-side-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    @media (max-width: 900px) {
      .slide-card-body { flex-direction: column; }
      .slide-card-side { flex: 0 0 auto; width: 100%; max-width: 320px; }
    }
</style>
</head>
<body>
  <div class="container">
    <h1>PrincePost</h1>

    <!-- Article Type Selection -->
    <div class="input-section" style="border-bottom: 2px solid #eaeaea; padding-bottom: 20px; margin-bottom: 20px;">
      <h2>Article Type</h2>
      <div style="display: flex; gap: 20px; margin-top: 10px;">
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="radio" name="articleType" value="opinion" id="typeOpinion" onchange="updateArticleType()" style="width: auto; margin-right: 8px;">
          <span style="font-size: 14px;">Opinion</span>
        </label>
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="radio" name="articleType" value="non-opinion" id="typeNonOpinion" onchange="updateArticleType()" style="width: auto; margin-right: 8px;" checked>
          <span style="font-size: 14px;">Non-Opinion</span>
        </label>
      </div>
    </div>

    <!-- Cover Slide Section -->
    <div class="input-section" style="border-bottom: 2px solid #eaeaea; padding-bottom: 30px; margin-bottom: 30px;">
      <h2>Cover Slide (Optional)</h2>
      <p style="font-size: 13px; color: #000000; margin-bottom: 15px;">Create a cover slide for your article</p>

      <div class="form-group">
        <label>Cover Template</label>
        <select id="coverTemplate">
          <option value="">None (No cover slide)</option>
          <option value="Opinion cover 1">Opinion cover 1</option>
          <option value="Opinion cover 2">Opinion cover 2</option>
        </select>
      </div>

      <!-- Cover template thumbnail grid -->
      <div class="form-group" style="margin-top: 10px;">
        <label style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <span>Choose a cover visually</span>
          <span style="font-size:12px; color:#000000;">Click a thumbnail to select</span>
        </label>

        <div id="coverThumbGrid" class="cover-thumb-grid" aria-label="Cover template thumbnails"></div>
        <div id="coverThumbHint" style="font-size:12px; color:#000000; margin-top:8px;"></div>
      </div>

      <div class="form-group">
        <label>Headline</label>
        <input type="text" id="coverHeadline" placeholder="Article headline" />
      </div>

      <div class="form-group">
        <label>Cover Image URL</label>
        <input type="url" id="coverImageUrl" placeholder="https://example.com/image.jpg" />
        <div style="font-size: 12px; color: #000000; margin-top: 5px;">Paste the direct URL to the cover image</div>
      </div>

      <div class="form-group">
        <label>Section</label>
        <input type="text" id="coverSection" placeholder="e.g., News" />
        <div style="font-size: 12px; color: #000000; margin-top: 5px;">Will be automatically capitalized</div>
      </div>

      <div id="authorFields" class="speaker-position-group">
        <div class="form-group">
          <label>Author Name</label>
          <input type="text" id="coverAuthorName" placeholder="e.g., Jane Smith" />
        </div>
        <div class="form-group">
          <label>Author Position</label>
          <input type="text" id="coverAuthorPosition" placeholder="e.g., Opinion Columnist" />
        </div>
      </div>
    </div>

    <div class="input-section">

      <div class="slides-section" id="slidesSection">
        <h2>Configure Your Slides</h2>
        <div id="slidesList" class="empty-state">
          No slides yet.
        </div>
        <!-- Add Slide UI: dropdown + button + thumbnail grid -->
<div class="slide-template-picker">
    <div class="slide-template-picker-row">
      <select id="addSlideTemplateSelect"></select>
      <button class="btn-secondary" id="addSlideBtn" type="button">+ Add Slide</button>
    </div>
  
    <div id="slideThumbGrid" class="slide-thumb-grid" aria-label="Slide template thumbnails"></div>
    <div id="slideThumbHint" style="font-size:12px; color:#000000; margin-top:8px;"></div>
  </div>
  
      </div>

      <div class="json-output">
        <h3>Export to Figma</h3>
        <div class="form-group" style="margin-bottom: 12px;">
          <label for="workspaceName">Workspace name</label>
          <input type="text" id="workspaceName" placeholder="e.g. miriam or team-1" style="width: 100%; padding: 8px 12px; border: 1px solid #eaeaea; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
          <small style="display: block; margin-top: 4px; color: #000000; font-size: 12px;">Use the same name in the Figma plugin so only your posts load there.</small>
        </div>
        <div class="form-group" style="margin-bottom: 12px;">
          <label for="apiBaseUrl">API URL (for this web app only)</label>
          <input type="text" id="apiBaseUrl" placeholder="Leave blank when using this page on Vercel" style="width: 100%; padding: 8px 12px; border: 1px solid #eaeaea; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
          <small style="display: block; margin-top: 4px; color: #000000; font-size: 12px;">Leave blank if you opened this page from your Vercel app (e.g. instagram-post-mu.vercel.app). The ‚ÄúSend to Figma‚Äù button will then use the same site‚Äôs API. Only fill this in if the page is hosted elsewhere (e.g. GitHub Pages) and your API is on Vercel.</small>
        </div>
        <div class="button-group" style="margin-bottom: 15px;">
          <button class="btn-success" onclick="sendToFigma()">Send to Figma</button>
          <button class="btn-secondary" onclick="copyJSON()">üìã Copy JSON</button>
          <button class="btn-secondary" onclick="downloadJSON()">üíæ Download</button>
        </div>
        <div class="json-display" id="jsonDisplay">Your JSON will appear here...</div>
      </div>
    </div>

    <div class="app-footer">
      Made with Princeluv by Miriam Waldvogel, ChatGPT, and Claude.
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    let slides = [];
    let slideIdCounter = 0;
    let isOpinion = true;

    // Templates loaded from templates.json (single source of truth)
let TEMPLATE_CONFIGS = {};
let quoteTemplates = [];
let coverTemplates = []; // [{ name, section }]

// Load templates.json and rebuild template lists.
// Expected schema per template:
// {
//   "Opinion cover 1": { "type":"cover", "section":"opinion", ... },
//   "News cover 1":    { "type":"cover", "section":"news", ... },
//   "One chunk quote": { "type":"slide", "section":"all", ... }
// }
async function loadTemplates() {
  const res = await fetch('/api/templates');
  if (!res.ok) throw new Error('Failed to load templates');

  TEMPLATE_CONFIGS = await res.json();

  quoteTemplates = [];
  coverTemplates = [];

  Object.entries(TEMPLATE_CONFIGS).forEach(([name, cfg]) => {
    const type = (cfg && cfg.type) ? cfg.type : null;
    const section = (cfg && cfg.section) ? cfg.section : 'all';

    if (type === 'slide') {
      quoteTemplates.push(name);
    } else if (type === 'cover') {
      coverTemplates.push({ name, section });
    }
  });
}

function getAvailableCoverTemplates() {
  // Opinion mode shows only section === "opinion"
  if (isOpinion) return coverTemplates.filter(t => t.section === 'opinion');

  // Non-opinion mode shows any cover whose section is NOT "opinion"
  return coverTemplates.filter(t => t.section !== 'opinion');
}


function getTemplateStructure(templateName) {
  const cfg = TEMPLATE_CONFIGS[templateName];
  if (cfg && Array.isArray(cfg.structure) && cfg.structure.length) {
    return cfg.structure;
  }
  return ["Quote 1"];
}

function hasNameOrPosition(templateName) {
  const cfg = TEMPLATE_CONFIGS[templateName];
  if (!cfg) return false;
  return ((cfg.nameFont || 0) > 0) || ((cfg.positionFont || 0) > 0);
}

function showNameField(templateName) {
  const cfg = TEMPLATE_CONFIGS[templateName];
  return cfg && (cfg.nameFont || 0) > 0;
}

function showPositionField(templateName) {
  const cfg = TEMPLATE_CONFIGS[templateName];
  return cfg && (cfg.positionFont || 0) > 0;
}

function hasBackgroundImage(templateName) {
  const cfg = TEMPLATE_CONFIGS[templateName];
  return !!(cfg && cfg.backgroundImage);
}


    function updateArticleType() {
      isOpinion = document.getElementById('typeOpinion').checked;

      // Update cover template options
      const coverTemplateSelect = document.getElementById('coverTemplate');
      const currentValue = coverTemplateSelect.value;

      coverTemplateSelect.innerHTML = '<option value="">None (No cover slide)</option>';

      const covers = getAvailableCoverTemplates().map(t => t.name);

      covers.forEach(cover => {
        const option = document.createElement('option');
        option.value = cover;
        option.textContent = cover;
        coverTemplateSelect.appendChild(option);
      });

      // Restore selection if still valid
      if (covers.includes(currentValue)) {
        coverTemplateSelect.value = currentValue;
      } else {
        coverTemplateSelect.value = '';
      }

      // Show/hide author fields and set section
      const authorFields = document.getElementById('authorFields');
      const sectionInput = document.getElementById('coverSection');

      if (isOpinion) {
        authorFields.style.display = 'grid';
        sectionInput.value = 'Opinion';
        sectionInput.disabled = true;
      } else {
        authorFields.style.display = 'none';
        sectionInput.disabled = false;
        if (sectionInput.value === 'Opinion') {
          sectionInput.value = '';
        }
      }

      // Update existing slides' speaker/position if switching to Opinion
      if (isOpinion) {
        const authorName = document.getElementById('coverAuthorName').value;
        const authorPosition = document.getElementById('coverAuthorPosition').value;

        slides.forEach(slide => {
          if (!slide.speaker && authorName) slide.speaker = authorName;
          if (!slide.position && authorPosition) slide.position = authorPosition;
        });

        renderSlides();
      }

      renderCoverThumbGrid();
      syncCoverThumbSelectionFromDropdown();
      updateJSON();
    }

    function parseQuotes() {
      const input = document.getElementById('quoteInput').value;
      if (!input.trim()) {
        showNotification('Please paste some quotes first!', 'error');
        return;
      }

      const chunks = input.split(/\n\n+/).filter(chunk => chunk.trim());

      const authorName = isOpinion ? document.getElementById('coverAuthorName').value : '';
      const authorPosition = isOpinion ? document.getElementById('coverAuthorPosition').value : '';

      slides = chunks.map(chunk => ({
        id: slideIdCounter++,
        template: "One chunk quote",
        texts: [chunk.trim()],
        speaker: authorName,
        position: authorPosition
      }));

      renderSlides();
      updateJSON();
      showNotification(`Created ${slides.length} slide${slides.length !== 1 ? 's' : ''}!`);
    }

    function updateSlide(id, field, value) {
      const slide = slides.find(s => s.id === id);
      if (slide) {
        slide[field] = value;

        if (field === 'template') {
          const structure = getTemplateStructure(value);
          const requiredChunks = structure.length;

          if (slide.texts.length < requiredChunks) {
            while (slide.texts.length < requiredChunks) slide.texts.push('');
          } else if (slide.texts.length > requiredChunks) {
            slide.texts = slide.texts.slice(0, requiredChunks);
          }

          renderSlides();
        }

        updateJSON();
      }
    }

    function updateChunkText(id, chunkIndex, element) {
      const slide = slides.find(s => s.id === id);
      if (slide) {
        let text = element.innerHTML;
        text = text.replace(/<b>/g, '**').replace(/<\/b>/g, '**');
        text = text.replace(/<div>/g, '\n').replace(/<\/div>/g, '');
        text = text.replace(/<br>/g, '\n');
        text = text.replace(/&nbsp;/g, ' ');
        text = text.replace(/<[^>]*>/g, '');

        slide.texts[chunkIndex] = text;
        updateJSON();
      }
    }

    function addChunk(id) {
      const slide = slides.find(s => s.id === id);
      if (slide) {
        const structure = getTemplateStructure(slide.template);
        const maxChunks = structure.length;
        if (slide.texts.length < maxChunks) {
          slide.texts.push('');
          renderSlides();
          updateJSON();
        } else {
          showNotification(`${slide.template} can only have ${maxChunks} chunk${maxChunks !== 1 ? 's' : ''}`, 'error');
        }
      }
    }

    // --- Slide template thumbnails + add-slide UI ---

let addSlideTemplate = "One chunk quote"; // default; will be validated on render

function slideThumbPath(templateName) {
  return `/api/thumbnails/slide/${encodeURIComponent(templateName)}`;
}

function renderAddSlideTemplateUI() {
  const select = document.getElementById('addSlideTemplateSelect');
  const grid = document.getElementById('slideThumbGrid');
  const hint = document.getElementById('slideThumbHint');
  const addBtn = document.getElementById('addSlideBtn');

  if (!select || !grid || !addBtn) return;

  // Ensure default exists; otherwise pick first available quote template
  if (!quoteTemplates.includes(addSlideTemplate)) {
    addSlideTemplate = quoteTemplates[0] || "One chunk quote";
  }

  // Populate dropdown from quoteTemplates (derived from TEMPLATE_CONFIGS)
  select.innerHTML = quoteTemplates.map(t =>
    `<option value="${t}" ${t === addSlideTemplate ? 'selected' : ''}>${t}</option>`
  ).join('');

  // Dropdown change -> just selects (does not create slide)
  select.onchange = () => {
    addSlideTemplate = select.value;
    syncSlideThumbSelection();
  };

  // Add button -> creates slide using selected template
  addBtn.onclick = () => addSlideWithTemplate(addSlideTemplate);

  // Grid -> clicking a thumbnail selects and also adds a slide immediately
  grid.innerHTML = quoteTemplates.map(name => {
    const pressed = (name === addSlideTemplate) ? 'true' : 'false';
    return `
      <button type="button" class="slide-thumb" aria-pressed="${pressed}" data-template="${name}">
        <div class="thumb-frame">
          <img src="${slideThumbPath(name)}"
               alt="${name} thumbnail"
               loading="lazy"
               onerror="this.style.opacity=0.35; this.title='Thumbnail not found: ${name}.png';" />
        </div>
        <div class="slide-thumb-title">${name}</div>
      </button>
    `;
  }).join('');

  grid.onclick = (e) => {
    const btn = e.target.closest('.slide-thumb');
    if (!btn) return;
    const template = btn.getAttribute('data-template');
    if (!template) return;

    addSlideTemplate = template;
    select.value = template;
    syncSlideThumbSelection();
    addSlideWithTemplate(template); // creates a slide immediately
  };

  if (hint) {
    hint.textContent = 'Tip: Click a thumbnail to add a slide instantly, or choose from the dropdown and click ‚Äú+ Add Slide‚Äù.';
  }

  syncSlideThumbSelection();
}

function syncSlideThumbSelection() {
  const grid = document.getElementById('slideThumbGrid');
  if (!grid) return;
  [...grid.querySelectorAll('.slide-thumb')].forEach(b => {
    b.setAttribute('aria-pressed', b.getAttribute('data-template') === addSlideTemplate ? 'true' : 'false');
  });
}

function addSlideWithTemplate(templateName) {
  const authorName = isOpinion ? document.getElementById('coverAuthorName').value : '';
  const authorPosition = isOpinion ? document.getElementById('coverAuthorPosition').value : '';

  const chosen = quoteTemplates.includes(templateName) ? templateName : (quoteTemplates[0] || "One chunk quote");
  const structure = getTemplateStructure(chosen);
  const texts = new Array(structure.length).fill("");

  slides.push({
    id: slideIdCounter++,
    template: chosen,
    texts,
    speaker: authorName,
    position: authorPosition,
    backgroundImageUrl: ''
  });

  renderSlides();
  updateJSON();
}

function removeSlide(id) {
  slides = slides.filter(s => s.id !== id);
  renderSlides();
  updateJSON();
}

function moveSlide(id, direction) {
  const index = slides.findIndex(s => s.id === id);
  if (index === -1) return;
  const newIndex = direction === 'up' ? index - 1 : index + 1;
  if (newIndex < 0 || newIndex >= slides.length) return;
  [slides[index], slides[newIndex]] = [slides[newIndex], slides[index]];
  renderSlides();
  updateJSON();
}


    function renderSlides() {
      const container = document.getElementById('slidesList');

      if (slides.length === 0) {
        container.innerHTML = '<div class="empty-state">No slides yet.</div>';
        return;
      }

      container.innerHTML = slides.map((slide, index) => `
        <div class="slide-card">
          <div class="slide-header">
            <div class="slide-title">Slide ${index + 1}</div>
            <div class="slide-controls">
              ${index > 0 ? `<button class="btn-small btn-secondary" onclick="moveSlide(${slide.id}, 'up')">‚Üë</button>` : ''}
              ${index < slides.length - 1 ? `<button class="btn-small btn-secondary" onclick="moveSlide(${slide.id}, 'down')">‚Üì</button>` : ''}
              <button class="btn-small btn-danger" onclick="removeSlide(${slide.id})">Remove</button>
            </div>
          </div>

          <div class="slide-card-body">
            <div class="slide-card-main">
              <div class="form-group">
                <label>Template</label>
                <select onchange="updateSlide(${slide.id}, 'template', this.value)" value="${slide.template}">
                  ${quoteTemplates.map(t => `<option value="${t}" ${slide.template === t ? 'selected' : ''}>${t}</option>`).join('')}
                </select>
              </div>

              <div class="form-group">
                <label>Text Chunks (Cmd/Ctrl+B to highlight orange)</label>
                ${slide.texts.map((text, i) => {
                  const displayText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                  const structure = getTemplateStructure(slide.template);
                  const chunkLabel = structure[i] || `Chunk ${i + 1}`;
                  return `
                    <div class="text-chunk">
                      <label style="font-size: 12px; font-weight: 600; color: #000000; margin-bottom: 4px; display: block;">${chunkLabel}</label>
                      <div class="editable-text" 
                           contenteditable="true" 
                           data-slide="${slide.id}" 
                           data-chunk="${i}"
                           onkeydown="handleKeydown(event, ${slide.id}, ${i})"
                           onblur="updateChunkText(${slide.id}, ${i}, this)"
                           oninput="updateChunkText(${slide.id}, ${i}, this)">${displayText}</div>

                    </div>
                  `;
                }).join('')}
                ${slide.texts.length < getTemplateStructure(slide.template).length ? `
                  <button class="btn-small btn-secondary add-chunk-btn" onclick="addChunk(${slide.id})">+ Add Chunk</button>
                ` : ''}
              </div>

              ${hasNameOrPosition(slide.template) ? `
              <div class="speaker-position-group">
                ${showNameField(slide.template) ? `
                <div class="form-group">
                  <label>Name (optional)</label>
                  <input type="text" value="${slide.speaker || ''}" onchange="updateSlide(${slide.id}, 'speaker', this.value)" placeholder="e.g., John Doe">
                </div>
                ` : ''}
                ${showPositionField(slide.template) ? `
                <div class="form-group">
                  <label>Position (optional)</label>
                  <input type="text" value="${slide.position || ''}" onchange="updateSlide(${slide.id}, 'position', this.value)" placeholder="e.g., Staff Writer">
                </div>
                ` : ''}
              </div>
              ` : ''}
              ${hasBackgroundImage(slide.template) ? `
              <div class="form-group" style="margin-top: 12px;">
                <label>Background image URL</label>
                <input type="text" value="${(slide.backgroundImageUrl || '')}" onchange="updateSlide(${slide.id}, 'backgroundImageUrl', this.value)" placeholder="https://...">
              </div>
              ` : ''}
            </div>

            <div class="slide-card-side">
              <div class="slide-side-preview" title="${slide.template}">
                <div class="thumb-frame">
                  <img src="${slideThumbPath(slide.template)}"
                       alt="${slide.template} thumbnail"
                       loading="lazy"
                       onerror="this.style.opacity=0.35; this.title='Thumbnail not found: ${slide.template}.png';" />
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }
function handleKeydown(event, slideId, chunkIndex) {
      if ((event.metaKey || event.ctrlKey) && event.key === 'b') {
        event.preventDefault();
        document.execCommand('bold', false, null);
      }
    }

    function updateJSON() {
  const output = {};

  const coverTemplate = document.getElementById('coverTemplate').value;

  if (coverTemplate) {
    const headline = document.getElementById('coverHeadline').value.trim();
    const imageUrl = document.getElementById('coverImageUrl').value.trim();
    const section = document.getElementById('coverSection').value.trim();
    const name = document.getElementById('coverAuthorName').value.trim();
    const position = document.getElementById('coverAuthorPosition').value.trim();

    // Always create coverSlide if template selected
    output.coverSlide = {
      template: coverTemplate,
      headline: headline,
      coverImageUrl: imageUrl,
      section: section ? section.toUpperCase() : ''
    };

    // Always include name/position for Opinion (even if empty)
    if (isOpinion) {
      output.coverSlide.name = name;
      output.coverSlide.position = position;
    }
  }

  output.slides = slides.map(slide => {
    const slideData = {
      template: slide.template,
      texts: slide.texts.filter(t => t.trim())
    };
    if (hasNameOrPosition(slide.template)) {
      slideData.speaker = slide.speaker || '';
      slideData.position = slide.position || '';
    }
    if (hasBackgroundImage(slide.template) && (slide.backgroundImageUrl || '').trim()) {
      slideData.backgroundImageUrl = (slide.backgroundImageUrl || '').trim();
    }
    return slideData;
  });

  document.getElementById('jsonDisplay').textContent = JSON.stringify(output, null, 2);
}

    function copyJSON() {
      const json = document.getElementById('jsonDisplay').textContent;
      navigator.clipboard.writeText(json).then(() => {
        showNotification('JSON copied to clipboard! Paste it into Figma plugin.');
      }).catch(err => {
        showNotification('Failed to copy. Please copy manually.', 'error');
      });
    }

    function downloadJSON() {
      const json = document.getElementById('jsonDisplay').textContent;
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'instagram-quotes.json';
      a.click();
      URL.revokeObjectURL(url);
      showNotification('JSON file downloaded!');
    }

    const WORKSPACE_STORAGE_KEY = 'audience_workspace';
    const API_BASE_STORAGE_KEY = 'audience_api_base';

    function getApiBase() {
      const el = document.getElementById('apiBaseUrl');
      const v = el ? el.value.trim() : '';
      return v ? v.replace(/\/$/, '') : '';
    }

    async function sendToFigma() {
      const workspaceEl = document.getElementById('workspaceName');
      const workspace = workspaceEl ? workspaceEl.value.trim() : '';
      if (!workspace) {
        showNotification('Enter a workspace name first.', 'error');
        return;
      }
      const json = document.getElementById('jsonDisplay').textContent;
      if (!json || json === 'Your JSON will appear here...') {
        showNotification('Add at least one slide or cover first.', 'error');
        return;
      }
      try {
        JSON.parse(json);
      } catch (e) {
        showNotification('Invalid JSON. Please fix the content.', 'error');
        return;
      }
      const base = getApiBase();
      const url = base ? `${base}/api/send` : '/api/send';
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ workspace, json }),
        });
        const contentType = (res.headers.get('Content-Type') || '').toLowerCase();
        const isJson = contentType.indexOf('application/json') !== -1;
        const data = isJson ? (await res.json().catch(function () { return {}; })) : {};
        if (!res.ok) {
          const errMsg = data.error || (res.status === 404 ? 'API not found. Is the URL correct?' : res.status === 502 ? 'Server error. Check Vercel logs.' : 'Error ' + res.status);
          showNotification(errMsg, 'error');
          return;
        }
        showNotification('Sent to Figma! Open Figma and click ‚ÄúGet from web‚Äù in the plugin.');
        try { localStorage.setItem(WORKSPACE_STORAGE_KEY, workspace); } catch (_) {}
        try { localStorage.setItem(API_BASE_STORAGE_KEY, base); } catch (_) {}
      } catch (e) {
        const msg = (e && e.message) ? e.message : 'Network error';
        showNotification('Request failed: ' + msg + (base ? '' : ' (try setting API URL to your Vercel URL)'), 'error');
      }
    }

    function clearAll() {
      if (confirm('Are you sure you want to clear everything?')) {
        slides = [];
        document.getElementById('coverTemplate').value = '';
        document.getElementById('coverHeadline').value = '';
        document.getElementById('coverImageUrl').value = '';
        document.getElementById('coverSection').value = isOpinion ? 'Opinion' : '';
        document.getElementById('coverAuthorName').value = '';
        document.getElementById('coverAuthorPosition').value = '';
        renderSlides();
        updateJSON();
        showNotification('All cleared!');
      }
    }

    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.background = type === 'error' ? '#dc3545' : '#28a745';
      notification.classList.add('show');

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // --- Cover thumbnail grid ---
    function coverThumbPath(templateName) {
      return `/api/thumbnails/cover/${encodeURIComponent(templateName)}`;
    }

    function renderCoverThumbGrid() {
      const grid = document.getElementById('coverThumbGrid');
      const hint = document.getElementById('coverThumbHint');
      const select = document.getElementById('coverTemplate');
      if (!grid || !select) return;

      const covers = getAvailableCoverTemplates().map(t => t.name);


      // If currently selected template isn't valid for this mode, clear it.
      if (select.value && !covers.includes(select.value)) {
        select.value = '';
        updateJSON();
      }

      if (!covers.length) {
        grid.innerHTML = '';
        if (hint) hint.textContent = 'No cover templates available for this article type.';
        return;
      }

      if (hint) {
        hint.textContent = isOpinion
          ? 'Showing Opinion covers only.'
          : 'Showing non-Opinion covers only.';
      }

      const selected = select.value;

      grid.innerHTML = covers.map(name => {
        const pressed = selected === name ? 'true' : 'false';
        return `
          <button type="button"
                  class="cover-thumb"
                  aria-pressed="${pressed}"
                  data-template="${name}">
            <div class="thumb-frame">
              <img src="${coverThumbPath(name)}"
                   alt="${name} thumbnail"
                   loading="lazy"
                   onerror="this.style.opacity=0.35; this.title='Thumbnail not found: ${name}.png';" />
            </div>
            <div class="cover-thumb-title">${name}</div>
          </button>
        `;
      }).join('');

      // Click handler (event delegation)
      grid.onclick = (e) => {
        const btn = e.target.closest('.cover-thumb');
        if (!btn) return;

        const template = btn.getAttribute('data-template');
        if (!template) return;

        select.value = template;

        // Update selected visuals
        [...grid.querySelectorAll('.cover-thumb')].forEach(b => {
          b.setAttribute('aria-pressed', b === btn ? 'true' : 'false');
        });

        // No notification popup on selection
        updateJSON();
      };
    }

    function syncCoverThumbSelectionFromDropdown() {
      const grid = document.getElementById('coverThumbGrid');
      const select = document.getElementById('coverTemplate');
      if (!grid || !select) return;

      const selected = select.value;
      [...grid.querySelectorAll('.cover-thumb')].forEach(b => {
        b.setAttribute('aria-pressed', b.getAttribute('data-template') === selected ? 'true' : 'false');
      });
    }

    // Load workspace and API URL from localStorage
    try {
      const savedWorkspace = localStorage.getItem(WORKSPACE_STORAGE_KEY);
      const savedApiBase = localStorage.getItem(API_BASE_STORAGE_KEY);
      const wEl = document.getElementById('workspaceName');
      const aEl = document.getElementById('apiBaseUrl');
      if (wEl && savedWorkspace != null) wEl.value = savedWorkspace;
      if (aEl && savedApiBase != null) aEl.value = savedApiBase;
      if (wEl) wEl.addEventListener('change', () => { try { localStorage.setItem(WORKSPACE_STORAGE_KEY, wEl.value.trim()); } catch (_) {} });
      if (aEl) aEl.addEventListener('change', () => { try { localStorage.setItem(API_BASE_STORAGE_KEY, aEl.value.trim()); } catch (_) {} });
    } catch (_) {}

    // Initialize (after templates.json is loaded)
(async () => {
  try {
    await loadTemplates();

    updateArticleType(); // will call renderCoverThumbGrid() etc.
    renderCoverThumbGrid();
    renderAddSlideTemplateUI();

    document.getElementById('coverTemplate').addEventListener('change', syncCoverThumbSelectionFromDropdown);

    // In case updateArticleType/render cover UI changed anything
    updateJSON();
  } catch (err) {
    console.error(err);
    // Optional: show a non-popup fallback message in the cover hint area
    const hint = document.getElementById('coverThumbHint');
    if (hint) hint.textContent = 'Error: could not load templates. Check server and /api/templates.';
  }
})();


    // Add event listeners for cover slide fields to update JSON
    ['coverTemplate', 'coverHeadline', 'coverImageUrl', 'coverSection', 'coverAuthorName', 'coverAuthorPosition'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', updateJSON);
        element.addEventListener('change', updateJSON);
      }
    });

    // Listen for author name/position changes to update all slides if Opinion
    document.getElementById('coverAuthorName').addEventListener('change', () => {
      if (isOpinion) {
        const authorName = document.getElementById('coverAuthorName').value;
        slides.forEach(slide => {
          if (!slide.speaker) slide.speaker = authorName;
        });
        renderSlides();
        updateJSON();
      }
    });

    document.getElementById('coverAuthorPosition').addEventListener('change', () => {
      if (isOpinion) {
        const authorPosition = document.getElementById('coverAuthorPosition').value;
        slides.forEach(slide => {
          if (!slide.position) slide.position = authorPosition;
        });
        renderSlides();
        updateJSON();
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PrincePost â€“ Template admin</title>
  <link rel="icon" href="favicon.png" type="image/x-icon">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #eaeaea;
      color: #000000;
      padding: 24px;
    }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { font-size: 1.5rem; margin-bottom: 24px; color: #000000; }
    .card { background: #ffffff; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #eaeaea; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .card h2 { font-size: 1.1rem; margin-bottom: 12px; color: #000000; }
    input[type="password"], input[type="text"], input[type="number"], input[type="file"], select, textarea, button { font: inherit; }
    input, select, textarea { padding: 8px 10px; border: 1px solid #eaeaea; border-radius: 6px; background: #ffffff; color: #000000; }
    input:focus, select:focus, textarea:focus { border-color: #b1d7fb; outline: none; }
    input[type="number"] { width: 80px; }
    input[type="checkbox"] { width: auto; margin-right: 8px; }
    label { display: block; margin-bottom: 4px; font-size: 14px; color: #000000; }
    .form-row { margin-bottom: 14px; }
    .form-row.inline { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .form-row.inline label { margin-bottom: 0; margin-right: 4px; }
    button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; background: #f15a24; color: #ffffff; }
    button:hover { background: #e87722; }
    button.danger { background: #000000; color: #ffffff; }
    button.danger:hover { background: #333; }
    button.secondary { background: #eaeaea; color: #000000; }
    button.secondary:hover { background: #b1d7fb; color: #000000; }
    textarea { width: 100%; min-height: 80px; padding: 12px; border: 1px solid #eaeaea; border-radius: 6px; background: #ffffff; color: #000000; font-size: 13px; resize: vertical; }
    .login-wrap { max-width: 320px; }
    .msg { margin-top: 12px; padding: 10px; border-radius: 6px; font-size: 14px; }
    .msg.error { background: #b1d7fb; color: #000000; border: 1px solid #eaeaea; }
    .msg.success { background: #b1d7fb; color: #000000; border: 1px solid #eaeaea; }
    .thumb-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; }
    .thumb-item { background: #ffffff; border-radius: 8px; padding: 12px; text-align: center; border: 1px solid #eaeaea; }
    .thumb-item img { width: 100%; height: auto; border-radius: 4px; background: #eaeaea; min-height: 80px; object-fit: contain; cursor: pointer; }
    .thumb-item .name { font-size: 12px; margin-top: 8px; word-break: break-word; color: #000000; }
    .thumb-item .actions { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
    .thumb-item .actions button { padding: 6px 10px; font-size: 12px; }
    .header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
    .back-to-princepost-container { margin-bottom: 20px; }
    .back-to-princepost-container a { display: inline-block; padding: 10px 16px; border-radius: 6px; background: #eaeaea; color: #000000; text-decoration: none; font-size: 14px; }
    .back-to-princepost-container a:hover { background: #b1d7fb; color: #000000; }
    .radio-group { display: flex; flex-wrap: wrap; gap: 12px 20px; align-items: center; }
    .radio-group label.radio-label { display: inline-flex; align-items: center; gap: 6px; margin-bottom: 0; cursor: pointer; font-weight: normal; }
    .radio-group input[type="radio"] { width: auto; margin: 0; }
    .hidden { display: none; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.hidden { display: none; }
    .modal { background: #ffffff; border-radius: 12px; padding: 24px; max-width: 480px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid #eaeaea; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .modal h3 { margin-bottom: 16px; color: #000000; }
    .modal .form-actions { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    .modal .form-actions button:first-child { margin-right: auto; }

    .add-form .form-block { margin-bottom: 16px; }
    .add-form .form-block.slide-only, .add-form .form-block.cover-only { display: none; }
    .add-form .form-block.slide-only.visible, .add-form .form-block.cover-only.visible { display: block; }
    .json-section summary { cursor: pointer; color: #000000; font-size: 14px; margin-bottom: 8px; }
    .json-section textarea { min-height: 200px; }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginView" class="card login-wrap">
      <h1>Template admin</h1>
      <h2>Log in</h2>
      <form id="loginForm">
        <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
        <button type="submit">Log in</button>
      </form>
      <div id="loginMsg" class="msg hidden"></div>
    </div>

    <div id="dashboardView" class="hidden">
      <div class="header-row">
        <h1>Template admin</h1>
        <button type="button" id="logoutBtn" class="secondary">Log out</button>
      </div>
      <div class="back-to-princepost-container">
        <a href="/" target="_blank">Back to PrincePost</a>
      </div>
      <!-- Add template form (add_template.py logic) -->
      <div class="card">
        <h2>Add template</h2>
        <form id="addTemplateForm" class="add-form">
          <div class="form-row">
            <label for="addName">Template name</label>
            <input type="text" id="addName" required placeholder="e.g. Opinion cover 1" />
          </div>
          <div class="form-row">
            <label>Type</label>
            <div class="radio-group">
              <label class="radio-label"><input type="radio" name="addType" value="slide" checked /> Slide</label>
              <label class="radio-label"><input type="radio" name="addType" value="cover" /> Cover</label>
            </div>
          </div>
          <div class="form-block cover-only" id="addSectionBlock">
            <label>Section (covers only)</label>
            <div class="radio-group">
              <label class="radio-label"><input type="radio" name="addSection" value="opinion" checked /> opinion</label>
              <label class="radio-label"><input type="radio" name="addSection" value="all" /> all</label>
            </div>
          </div>
          <div class="form-block slide-only" id="addStructureBlock">
            <label for="addStructure">Structure (comma-separated layer names, slides only)</label>
            <input type="text" id="addStructure" placeholder="Quote 1, Quote 2" value="Quote 1" />
          </div>
          <div class="form-row inline">
            <label for="addMaxFont">maxFont</label>
            <input type="number" id="addMaxFont" min="1" value="80" required />
            <label for="addNameFont">nameFont (0 = none)</label>
            <input type="number" id="addNameFont" min="0" value="60" />
            <label for="addPositionFont">positionFont (0 = none)</label>
            <input type="number" id="addPositionFont" min="0" value="50" />
          </div>
          <div class="form-row inline">
            <input type="checkbox" id="addBackgroundImage" />
            <label for="addBackgroundImage" class="inline">Background image</label>
          </div>
          <div class="form-row">
            <label for="addThumbFile">Thumbnail (optional PNG; saved as &lt;Template name&gt;.png)</label>
            <input type="file" id="addThumbFile" accept="image/png,.png" />
          </div>
          <div class="form-actions">
            <button type="submit">Add template</button>
            <span id="addFormMsg" class="msg hidden" style="margin-left:12px;"></span>
          </div>
        </form>
      </div>

      <!-- Edit template modal -->
      <div id="editModal" class="modal-overlay hidden">
        <div class="modal">
          <h3 id="editModalTitle">Edit template</h3>
          <form id="editTemplateForm">
            <input type="hidden" id="editName" />
            <div class="form-row">
              <label>Template name</label>
              <input type="text" id="editNameDisplay" disabled />
            </div>
            <div class="form-row">
              <label>Type</label>
              <div class="radio-group">
                <label class="radio-label"><input type="radio" name="editType" value="slide" /> Slide</label>
                <label class="radio-label"><input type="radio" name="editType" value="cover" /> Cover</label>
              </div>
            </div>
            <div class="form-block cover-only" id="editSectionBlock">
              <label>Section</label>
              <div class="radio-group">
                <label class="radio-label"><input type="radio" name="editSection" value="opinion" /> opinion</label>
                <label class="radio-label"><input type="radio" name="editSection" value="news" /> news</label>
                <label class="radio-label"><input type="radio" name="editSection" value="features" /> features</label>
                <label class="radio-label"><input type="radio" name="editSection" value="sports" /> sports</label>
                <label class="radio-label"><input type="radio" name="editSection" value="prospect" /> prospect</label>
                <label class="radio-label"><input type="radio" name="editSection" value="all" /> all</label>
              </div>
            </div>
            <div class="form-block slide-only" id="editStructureBlock">
              <label for="editStructure">Structure (comma-separated)</label>
              <input type="text" id="editStructure" placeholder="Quote 1, Quote 2" />
            </div>
            <div class="form-row inline">
              <label for="editMaxFont">maxFont</label>
              <input type="number" id="editMaxFont" min="1" required />
              <label for="editNameFont">nameFont</label>
              <input type="number" id="editNameFont" min="0" />
              <label for="editPositionFont">positionFont</label>
              <input type="number" id="editPositionFont" min="0" />
            </div>
            <div class="form-row inline">
              <input type="checkbox" id="editBackgroundImage" />
              <label for="editBackgroundImage" class="inline">Background image</label>
            </div>
            <div class="form-actions">
              <button type="button" id="editModalCancel" class="secondary">Cancel</button>
              <button type="submit">Save</button>
              <span id="editFormMsg" class="msg hidden" style="margin-left:12px;"></span>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <h2>Cover templates</h2>
        <p style="margin-bottom:12px;font-size:14px;color:#000000;">Click a thumbnail to edit, or use Delete to remove the image.</p>
        <div id="coverThumbList" class="thumb-list"></div>
      </div>

      <div class="card">
        <h2>Slide templates</h2>
        <p style="margin-bottom:12px;font-size:14px;color:#000000;">Click a thumbnail to edit, or use Delete to remove the image.</p>
        <div id="slideThumbList" class="thumb-list"></div>
      </div>

      <div class="card json-section">
        <details>
          <summary>Advanced: edit JSON by hand</summary>
          <textarea id="templatesJson" spellcheck="false"></textarea>
          <div style="margin-top:10px;">
            <button type="button" id="saveTemplatesBtn">Save templates</button>
            <span id="templatesMsg" class="msg hidden" style="margin-left:12px;"></span>
          </div>
        </details>
      </div>
    </div>
  </div>

  <script>
    const loginView = document.getElementById('loginView');
    const dashboardView = document.getElementById('dashboardView');
    const loginForm = document.getElementById('loginForm');
    const loginMsg = document.getElementById('loginMsg');
    const passwordInput = document.getElementById('password');
    const logoutBtn = document.getElementById('logoutBtn');
    const templatesJson = document.getElementById('templatesJson');
    const saveTemplatesBtn = document.getElementById('saveTemplatesBtn');
    const templatesMsg = document.getElementById('templatesMsg');
    const coverThumbList = document.getElementById('coverThumbList');
    const slideThumbList = document.getElementById('slideThumbList');
    const addTemplateForm = document.getElementById('addTemplateForm');
    const addFormMsg = document.getElementById('addFormMsg');
    const editModal = document.getElementById('editModal');
    const editTemplateForm = document.getElementById('editTemplateForm');
    const editFormMsg = document.getElementById('editFormMsg');
    const editModalCancel = document.getElementById('editModalCancel');

    let currentTemplates = {};

    const SECTIONS = ['opinion', 'news', 'features', 'sports', 'prospect', 'all'];

    function showMsg(el, text, isError) {
      el.textContent = text;
      el.className = 'msg ' + (isError ? 'error' : 'success');
      el.classList.remove('hidden');
    }
    function hideMsg(el) {
      el.classList.add('hidden');
    }

    function toggleAddFormBlocks() {
      const type = document.querySelector('input[name="addType"]:checked')?.value || 'slide';
      document.getElementById('addSectionBlock').classList.toggle('visible', type === 'cover');
      document.getElementById('addStructureBlock').classList.toggle('visible', type === 'slide');
    }
    function toggleEditFormBlocks() {
      const type = document.querySelector('input[name="editType"]:checked')?.value || 'slide';
      document.getElementById('editSectionBlock').classList.toggle('visible', type === 'cover');
      document.getElementById('editStructureBlock').classList.toggle('visible', type === 'slide');
    }
    document.querySelectorAll('input[name="addType"]').forEach((el) => el.addEventListener('change', toggleAddFormBlocks));
    document.querySelectorAll('input[name="editType"]').forEach((el) => el.addEventListener('change', toggleEditFormBlocks));

    async function checkSession() {
      const r = await fetch('/api/auth/session', { credentials: 'include' });
      if (r.ok) {
        loginView.classList.add('hidden');
        dashboardView.classList.remove('hidden');
        loadTemplates();
        return true;
      }
      loginView.classList.add('hidden');
      dashboardView.classList.add('hidden');
      return false;
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMsg(loginMsg);
      const password = passwordInput.value.trim();
      if (!password) {
        showMsg(loginMsg, 'Enter password', true);
        return;
      }
      const r = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ password }),
      });
      const data = r.ok ? await r.json().catch(() => ({})) : { error: (await r.json().catch(() => ({}))).error || 'Login failed' };
      if (r.ok && data.ok) {
        await checkSession();
      } else {
        showMsg(loginMsg, data.error || 'Invalid password', true);
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      await checkSession();
    });

    async function loadTemplates() {
      const r = await fetch('/api/templates', { credentials: 'include' });
      if (!r.ok) {
        currentTemplates = {};
        templatesJson.value = '{}';
        renderThumbLists({});
        return;
      }
      const data = await r.json();
      currentTemplates = data;
      templatesJson.value = JSON.stringify(data, null, 2);
      renderThumbLists(data);
      toggleAddFormBlocks();
    }

    function buildEntryFromForm(prefix) {
      const type = document.querySelector(`input[name="${prefix}Type"]:checked`)?.value || 'slide';
      const section = type === 'cover' ? (document.querySelector(`input[name="${prefix}Section"]:checked`)?.value || 'opinion') : 'all';
      const structureStr = document.getElementById(prefix + 'Structure').value.trim();
      const structure = structureStr ? structureStr.split(',').map((s) => s.trim()).filter(Boolean) : ['Quote 1'];
      const maxFont = parseInt(document.getElementById(prefix + 'MaxFont').value, 10) || 80;
      const nameFont = parseInt(document.getElementById(prefix + 'NameFont').value, 10) || 0;
      const positionFont = parseInt(document.getElementById(prefix + 'PositionFont').value, 10) || 0;
      const backgroundImage = document.getElementById(prefix + 'BackgroundImage').checked;
      const entry = {
        type,
        section,
        maxFont,
        nameFont,
        positionFont,
        backgroundImage,
      };
      if (type === 'slide') entry.structure = structure;
      return entry;
    }

    addTemplateForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMsg(addFormMsg);
      const name = document.getElementById('addName').value.trim();
      if (!name) {
        showMsg(addFormMsg, 'Template name is required', true);
        return;
      }
      if (currentTemplates[name]) {
        showMsg(addFormMsg, 'A template with this name already exists. Edit it from the list or use a different name.', true);
        return;
      }
      const entry = buildEntryFromForm('add');
      const thumbFile = document.getElementById('addThumbFile').files[0];

      currentTemplates[name] = entry;
      const r = await fetch('/api/templates', {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(currentTemplates),
      });
      if (!r.ok) {
        delete currentTemplates[name];
        const err = (await r.json().catch(() => ({}))).error || 'Save failed';
        showMsg(addFormMsg, err, true);
        return;
      }
      if (thumbFile) {
        const base64 = await fileToBase64(thumbFile);
        const type = entry.type;
        const thumbUrl = `/api/thumbnails/${type}/${encodeURIComponent(name)}`;
        const tr = await fetch(thumbUrl, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: base64 }),
        });
        if (!tr.ok) {
          const err = (await tr.json().catch(() => ({}))).error || 'Thumbnail upload failed';
          showMsg(addFormMsg, 'Template saved but thumbnail failed: ' + err, true);
        }
      }
      showMsg(addFormMsg, 'Template added.', false);
      document.getElementById('addThumbFile').value = '';
      loadTemplates();
      setTimeout(() => hideMsg(addFormMsg), 3000);
    });

    function openEditModal(name) {
      const cfg = currentTemplates[name];
      if (!cfg) return;
      document.getElementById('editName').value = name;
      document.getElementById('editNameDisplay').value = name;
      const editTypeVal = cfg.type || 'slide';
      const editSectionVal = cfg.section || 'opinion';
      document.querySelectorAll('input[name="editType"]').forEach((r) => { r.checked = r.value === editTypeVal; });
      document.querySelectorAll('input[name="editSection"]').forEach((r) => { r.checked = r.value === editSectionVal; });
      document.getElementById('editStructure').value = Array.isArray(cfg.structure) ? cfg.structure.join(', ') : 'Quote 1';
      document.getElementById('editMaxFont').value = cfg.maxFont ?? 80;
      document.getElementById('editNameFont').value = cfg.nameFont ?? 0;
      document.getElementById('editPositionFont').value = cfg.positionFont ?? 0;
      document.getElementById('editBackgroundImage').checked = !!cfg.backgroundImage;
      toggleEditFormBlocks();
      hideMsg(editFormMsg);
      editModal.classList.remove('hidden');
    }

    function closeEditModal() {
      editModal.classList.add('hidden');
    }

    editModalCancel.addEventListener('click', closeEditModal);
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) closeEditModal();
    });

    editTemplateForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMsg(editFormMsg);
      const name = document.getElementById('editName').value.trim();
      if (!name || !currentTemplates[name]) {
        closeEditModal();
        return;
      }
      const entry = buildEntryFromForm('edit');
      currentTemplates[name] = entry;
      const r = await fetch('/api/templates', {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(currentTemplates),
      });
      if (r.ok) {
        showMsg(editFormMsg, 'Saved.', false);
        templatesJson.value = JSON.stringify(currentTemplates, null, 2);
        renderThumbLists(currentTemplates);
        setTimeout(() => { closeEditModal(); hideMsg(editFormMsg); }, 800);
      } else {
        const err = (await r.json().catch(() => ({}))).error || 'Save failed';
        showMsg(editFormMsg, err, true);
      }
    });

    function renderThumbLists(templates) {
      const covers = [];
      const slides = [];
      if (templates && typeof templates === 'object') {
        Object.entries(templates).forEach(([name, cfg]) => {
          if (cfg && cfg.type === 'cover') covers.push(name);
          if (cfg && cfg.type === 'slide') slides.push(name);
        });
      }
      coverThumbList.innerHTML = covers.map((name) => thumbItemHtml('cover', name)).join('');
      slideThumbList.innerHTML = slides.map((name) => thumbItemHtml('slide', name)).join('');
      coverThumbList.querySelectorAll('.thumb-item').forEach((el) => {
        const name = el.dataset.name;
        el.querySelector('img').addEventListener('click', () => openEditModal(name));
        el.querySelector('.name').addEventListener('click', () => openEditModal(name));
      });
      coverThumbList.querySelectorAll('button[data-action="delete"]').forEach((btn) => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); deleteThumb('cover', btn.dataset.name); });
      });
      coverThumbList.querySelectorAll('button[data-action="edit"]').forEach((btn) => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(btn.dataset.name); });
      });
      slideThumbList.querySelectorAll('.thumb-item').forEach((el) => {
        const name = el.dataset.name;
        el.querySelector('img').addEventListener('click', () => openEditModal(name));
        el.querySelector('.name').addEventListener('click', () => openEditModal(name));
      });
      slideThumbList.querySelectorAll('button[data-action="delete"]').forEach((btn) => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); deleteThumb('slide', btn.dataset.name); });
      });
      slideThumbList.querySelectorAll('button[data-action="edit"]').forEach((btn) => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(btn.dataset.name); });
      });
    }

    function thumbItemHtml(type, name) {
      const url = `/api/thumbnails/${type}/${encodeURIComponent(name)}`;
      return `
        <div class="thumb-item" data-name="${escapeHtml(name)}">
          <img src="${url}" alt="${escapeHtml(name)}" loading="lazy" onerror="this.style.opacity=0.35;this.alt='No image';" title="Click to edit" />
          <div class="name" title="Click to edit">${escapeHtml(name)}</div>
          <div class="actions">
            <button type="button" data-action="edit" data-name="${escapeHtml(name)}">Edit</button>
            <button type="button" data-action="delete" data-name="${escapeHtml(name)}" class="danger">Delete</button>
          </div>
        </div>
      `;
    }
    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const dataUrl = fr.result;
          const base64 = dataUrl.replace(/^data:[^;]+;base64,/, '');
          resolve(base64);
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    async function deleteThumb(type, name) {
      if (!confirm(`Delete thumbnail for "${name}"? (Template data will remain; you can replace the image later.)`)) return;
      const url = `/api/thumbnails/${type}/${encodeURIComponent(name)}`;
      const r = await fetch(url, { method: 'DELETE', credentials: 'include' });
      if (r.ok) {
        const item = document.querySelector(`.thumb-item[data-name="${escapeHtml(name)}"]`);
        if (item) {
          const img = item.querySelector('img');
          if (img) img.src = '';
        }
      } else {
        const err = (await r.json().catch(() => ({}))).error || 'Delete failed';
        alert(err);
      }
    }

    saveTemplatesBtn.addEventListener('click', async () => {
      hideMsg(templatesMsg);
      let data;
      try {
        data = JSON.parse(templatesJson.value);
      } catch (e) {
        showMsg(templatesMsg, 'Invalid JSON: ' + e.message, true);
        return;
      }
      if (typeof data !== 'object' || data === null) {
        showMsg(templatesMsg, 'JSON must be an object', true);
        return;
      }
      const r = await fetch('/api/templates', {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (r.ok) {
        currentTemplates = data;
        showMsg(templatesMsg, 'Saved.', false);
        renderThumbLists(data);
        setTimeout(() => hideMsg(templatesMsg), 3000);
      } else {
        const err = (await r.json().catch(() => ({}))).error || 'Save failed';
        showMsg(templatesMsg, err, true);
      }
    });

    checkSession();
  </script>
</body>
</html>
